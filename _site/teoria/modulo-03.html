<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Módulo 3 – Gestión de carteras – EFA Nivel II</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0c6962ea503ec3181c9c89cb2fb18b87.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../efpa_logo_web_resized.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">EFA Nivel II</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Buscar"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navegación de palanca" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Inicio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../sesiones/index.html"> 
<span class="menu-text">Sesiones</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../teoria/index.html" aria-current="page"> 
<span class="menu-text">Teoría</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../teoria/modulo-03.html">Módulo 3 – Gestión de carteras</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Teoría</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 1 – Instrumentos y mercados financieros</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 2 – Fondos y sociedades de inversión</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-03.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Módulo 3 – Gestión de carteras</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 4 – Seguros</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 5 – Pensiones y planificación</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 6 – Inversión inmobiliaria</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 7 – Crédito y financiación</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 8 – Fiscalidad de las inversiones</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 9 – Marco regulatorio y planificación</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../teoria/modulo-10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Módulo 10 – Repaso final y simulacro</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Módulo 3 – Gestión de carteras</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="a.-eficiencia-de-los-mercados" class="level1">
<h1>A. Eficiencia de los mercados</h1>
<section id="a.1-concepto-de-mercado-eficiente" class="level2">
<h2 class="anchored" data-anchor-id="a.1-concepto-de-mercado-eficiente">A.1 Concepto de mercado eficiente</h2>
<p>El concepto de mercado eficiente es el fundamento de toda la teoría financiera moderna, no sólo por su utilidad para comprender el comportamiento de los mercados, sino también para afrontar las dudas y anomalías que se dan en la práctica y que deben tenerse en cuenta ante cualquier estrategia financiera.</p>
<p>La eficiencia de los mercados puede entenderse desde dos perspectivas:</p>
<section id="perspectiva-funcional-u-operacional" class="level3">
<h3 class="anchored" data-anchor-id="perspectiva-funcional-u-operacional">Perspectiva funcional u operacional</h3>
<ul>
<li><strong>Flexibilidad</strong>: No existen costes de gestión ni de transacción ni impuestos asociados a la posesión o transmisión de títulos.</li>
<li><strong>Libertad</strong>: No hay restricciones de entrada ni salida para los participantes del mercado.</li>
<li><strong>Estabilidad</strong>: No hay fluctuaciones bruscas en los tipos de interés ni en los precios.</li>
<li><strong>Homogeneidad</strong>: Los activos financieros son totalmente homogéneos e infinitamente divisibles.</li>
</ul>
</section>
<section id="perspectiva-informativa" class="level3">
<h3 class="anchored" data-anchor-id="perspectiva-informativa">Perspectiva informativa</h3>
<ul>
<li><strong>Transparencia</strong>: Toda la información relevante es pública y conocida por todos los participantes, que reaccionan de forma inmediata ajustando los precios.</li>
<li><strong>Amplitud</strong>: Existen numerosos inversores, sin que ninguno tenga suficiente peso como para alterar los precios por sí solo.</li>
</ul>
<p>📌 En estas condiciones ideales, el precio actual sería la mejor estimación del precio futuro, ya que incorpora toda la información relevante disponible. Como la nueva información es imprevisible, también lo serían los movimientos de los precios. Este comportamiento aleatorio de los precios es lo que se conoce como <strong>camino aleatorio</strong> (<em>random walk</em>).</p>
<hr>
</section>
</section>
<section id="a.2-formas-de-eficiencia-del-mercado" class="level2">
<h2 class="anchored" data-anchor-id="a.2-formas-de-eficiencia-del-mercado">A.2 Formas de eficiencia del mercado</h2>
<p>Existen tres hipótesis o niveles de eficiencia del mercado, según el tipo de información que se considera ya reflejada en los precios:</p>
<ul>
<li><strong>Hipótesis débil</strong>: Los precios recogen toda la información pasada (series históricas de precios).</li>
<li><strong>Hipótesis semifuerte</strong>: Los precios recogen la información histórica y toda la información pública disponible (noticias, balances, etc.).</li>
<li><strong>Hipótesis fuerte</strong>: Los precios recogen toda la información, incluyendo la pública y también la privada o privilegiada.</li>
</ul>
<section id="consecuencias" class="level3">
<h3 class="anchored" data-anchor-id="consecuencias">Consecuencias:</h3>
<ul>
<li>En los tres niveles, el <strong>análisis técnico no sería útil</strong>, al estar basada en patrones históricos.</li>
<li>En la <strong>eficiencia semifuerte</strong>, el <strong>análisis fundamental también dejaría de tener utilidad</strong>, ya que la información pública ya estaría recogida en los precios.</li>
<li>En la <strong>eficiencia fuerte</strong>, ni siquiera el uso de información privilegiada (<strong>insider trading</strong>) generaría beneficios.</li>
</ul>
<hr>
</section>
<section id="cuadro-1.-niveles-de-eficiencia-del-mercado" class="level3">
<h3 class="anchored" data-anchor-id="cuadro-1.-niveles-de-eficiencia-del-mercado">Cuadro 1. Niveles de eficiencia del mercado</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 45%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Nivel de eficiencia</strong></th>
<th><strong>Los precios reflejan…</strong></th>
<th><strong>Consecuencia</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Débil</strong></td>
<td>Toda la información del pasado</td>
<td>❌ El análisis técnico no sirve</td>
</tr>
<tr class="even">
<td><strong>Intermedio o semifuerte</strong></td>
<td>Información histórica + toda la información pública disponible</td>
<td>❌ El análisis fundamental no sirve</td>
</tr>
<tr class="odd">
<td><strong>Fuerte</strong></td>
<td>Información histórica, pública y también privada o privilegiada</td>
<td>❌ El <em>insider trading</em> no genera beneficios</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p>📌 <strong>Importante</strong>: Estos niveles son acumulativos. La hipótesis semifuerte incluye la débil, y la fuerte incluye a ambas. Por tanto, <strong>no se debe interpretar que si no sirve un análisis, sí servirá el otro</strong>.</p>
</blockquote>
<hr>
</section>
</section>
<section id="a.3-consecuencias-de-la-eficiencia-del-mercado" class="level2">
<h2 class="anchored" data-anchor-id="a.3-consecuencias-de-la-eficiencia-del-mercado">A.3 Consecuencias de la eficiencia del mercado</h2>
<p>Si el mercado es completamente eficiente, los precios ya reflejan toda la información disponible. En ese caso:</p>
<ul>
<li>La <strong>mejor estrategia sería la gestión pasiva</strong>, que consiste en replicar un índice representativo del mercado.</li>
<li>Esta gestión minimiza los <strong>costes de rotación</strong>, <strong>análisis</strong> y <strong>comisiones</strong>.</li>
</ul>
<p>Sin embargo, en la práctica, los mercados <strong>no siempre son completamente eficientes</strong> debido a:</p>
<ul>
<li>Retrasos en la incorporación de la información a los precios.</li>
<li>Información incompleta o sesgada.</li>
<li>Comportamientos no racionales de algunos inversores.</li>
<li>Costes de gestión, transacción e impuestos.</li>
<li>Barreras legales u operativas que afectan a ciertos participantes.</li>
</ul>
<p>➡️ En estos casos, puede tener sentido una <strong>gestión activa</strong>, que busque batir al mercado mediante análisis y selección de títulos. Pero esta estrategia solo será rentable <strong>si los costes asociados no superan los beneficios obtenidos</strong> —especialmente importante para el pequeño inversor.</p>
<hr>
</section>
<section id="resumen" class="level2">
<h2 class="anchored" data-anchor-id="resumen">🧠 Resumen</h2>
<ul>
<li>Un mercado eficiente es aquel en el que los precios se ajustan rápida y exactamente tras la aparición de nueva información.</li>
<li>Existen tres hipótesis de eficiencia:
<ul>
<li><strong>Débil</strong>: los precios reflejan la información histórica.</li>
<li><strong>Semifuerte</strong>: los precios reflejan la información histórica y pública.</li>
<li><strong>Fuerte</strong>: los precios reflejan toda la información, incluso la privilegiada.</li>
</ul></li>
<li>Aunque los mercados tienden a ser eficientes, existen imperfecciones que pueden justificar la <strong>gestión activa</strong> en determinados contextos.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>